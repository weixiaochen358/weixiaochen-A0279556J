<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Electricity Price Analysis</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .line {
            fill: none;
            stroke-width: 1.5px;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 12px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 6px;
            font-size: 14px;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>

<body>
    <svg width="1260" height="500"></svg>
    <script>
        const svg = d3.select("svg"),
            margin = { top: 20, right: 160, bottom: 30, left: 50 },
            width = svg.attr("width") - margin.left - margin.right,
            height = svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const parseTime = d3.timeParse("%Y-%m");

        const x = d3.scaleTime().rangeRound([0, width]),
            y = d3.scaleLinear().rangeRound([height, 0]),
            z = d3.scaleOrdinal(d3.schemeCategory10);

        const line = d3.line()
            .x(d => x(d.date))
            .y(d => y(d.price));

        d3.csv("clean_data.csv", function (d) {
            d.date = parseTime(d.year + "-" + d.month);
            d.price = +d.price;
            return d;
        }).then(function (data) {
            const states = Array.from(new Set(data.map(d => d.stateDescription))),
                colors = d3.scaleOrdinal(d3.schemeCategory10).domain(states);

            const dataNested = d3.group(data, d => d.stateDescription);

            x.domain(d3.extent(data, d => d.date));
            y.domain([
                d3.min(data, d => d.price),
                d3.max(data, d => d.price)
            ]);

            z.domain(states);

            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Price ($/kWh)");

            for (const [state, values] of dataNested) {
                g.append("path")
                    .datum(values)
                    .attr("fill", "none")
                    .attr("stroke", colors(state))
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 1.5)
                    .attr("d", line);
            }
            // 添加图例
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width + margin.right/2}, ${margin.top})`)
                .selectAll("g")
                .data(states)
                .enter().append("g")
                .attr("transform", (d, i) => `translate(0, ${i * 20})`);

            legend.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .attr("fill", z);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .attr("text-anchor", "start")
                .text(d => d)
                .attr("font-family", "sans-serif")
                .attr("font-size", 12);

        });




    </script>
</body>

</html>